{% extends "plantilla.html" %}
{% load static %}

{% block body %}
<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="row g-5">
            <div class="col-lg-8">
                <h1 class="display-4 mb-4 text-primary">{{ vehiculo.marca.nombre }} {{ vehiculo.modelo.nombre }} ({{ vehiculo.anio_fabricacion }})</h1>
                
                <div class="mb-4">
                    <h3>Precio: <strong class="text-secondary">${{ vehiculo.precio|floatformat:2 }}</strong></h3>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><i class="fa fa-tachometer-alt text-primary me-2"></i> <strong>Kilometraje:</strong> {{ vehiculo.kilometraje|floatformat:0 }} km</p>
                        <p><i class="fa fa-gas-pump text-primary me-2"></i> <strong>Combustible:</strong> {{ vehiculo.tipo_combustible.nombre|default:"N/A" }}</p>
                        <p><i class="fa fa-cogs text-primary me-2"></i> <strong>Transmisión:</strong> {{ vehiculo.tipo_transmision.nombre|default:"N/A" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><i class="fa fa-car text-primary me-2"></i> <strong>Carrocería:</strong> {{ vehiculo.tipo_carroceria.nombre|default:"N/A" }}</p>
                        <p><i class="fa fa-id-card text-primary me-2"></i> <strong>Nº Chasis:</strong> {{ vehiculo.numero_chasis }}</p>
                        <p><i class="fa fa-tags text-primary me-2"></i> <strong>Placa:</strong> {{ vehiculo.placa|default:"N/A" }}</p>
                    </div>
                </div>

                <p class="mb-4">
                    <strong>Descripción:</strong>
                    {% if vehiculo.descripcion %}
                        {{ vehiculo.descripcion|linebreaksbr }}
                    {% else %}
                        No hay una descripción disponible para este vehículo.
                    {% endif %}
                </p>

                ---
                
                <h4 class="mb-3">Galería de Imágenes</h4>
                <div class="row g-3">
                    {% for imagen in vehiculo.imagenes.all %}
                        <div class="col-sm-6 col-md-4 col-lg-3">
                            <a href="{{ imagen.imagen.url }}" target="_blank" title="Ver imagen en tamaño completo">
                                <img src="{{ imagen.imagen.url }}" class="img-fluid rounded shadow-sm" alt="Imagen de {{ vehiculo.marca.nombre }} {{ vehiculo.modelo.nombre }}" style="object-fit: cover; height: 150px; width: 100%;">
                            </a>
                            {% if imagen.es_principal %}
                                <p class="text-center mt-1"><span class="badge bg-primary">Imagen Principal</span></p>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="text-secondary">No hay imágenes disponibles para este vehículo.</p>
                        </div>
                    {% endfor %}
                </div>
                
                <hr class="my-5">

                <div class="d-flex justify-content-start mt-5">
                    <a href="{% url 'reservar_vehiculo' vehiculo.id %}" class="btn btn-primary btn-lg me-3">
                        <span class="me-2">Reservar este Vehículo</span> <i class="fa fa-calendar-check"></i>
                    </a>
                    <a href="{% url 'catalogo_vehiculos_cliente' %}" class="btn btn-secondary btn-lg">
                        <span class="me-2">Volver al Catálogo</span> <i class="fa fa-arrow-left"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="bg-light rounded p-4 shadow-sm">
                    <h5 class="mb-4">Información Adicional</h5>
                    <p><strong>Situación:</strong> <span class="badge bg-info">{{ vehiculo.get_situacion_general_display }}</span></p>
                    <p><strong>Publicado:</strong> {{ vehiculo.fecha_publicacion|date:"d M Y H:i" }}</p>
                    <p><strong>Disponible para venta:</strong>
                        {% if vehiculo.disponible_para_venta %}
                            <span class="badge bg-success">Sí</span>
                        {% else %}
                            <span class="badge bg-danger">No</span>
                        {% endif %}
                    </p>
                    <hr>
                    <p class="mb-0 text-muted">¿Interesado? ¡Contáctanos para más detalles!</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const itemsPerPageSelectServices = document.getElementById('entries_per_page_services');
        const searchInputServices = document.getElementById('search_input_services');
        const cardsContainerServices = document.getElementById('characteristc_cards_container_services');
        const cardsServices = Array.from(cardsContainerServices.getElementsByClassName('col-md-6'));
        const paginationInfoServices = document.getElementById('pagination_info_services');
        const prevButtonServices = document.getElementById('prev_page_btn_services');
        const nextButtonServices = document.getElementById('next_page_btn_services');
        const pageNumbersContainerServices = document.getElementById('page_numbers_services');
        let currentPageServices = 1;
        let itemsPerPageServices = parseInt(itemsPerPageSelectServices.value);

        function filterAndPaginateServices() {
            const searchTerm = searchInputServices.value.toLowerCase().trim();
            const filteredCards = cardsServices.filter(card => {
                const cardText = card.getAttribute('data-search-term');
                return cardText.includes(searchTerm);
            });
            const totalItems = filteredCards.length;
            const totalPages = itemsPerPageServices === -1 ? 1 : Math.ceil(totalItems / itemsPerPageServices);
            
            if (currentPageServices > totalPages && totalPages > 0) {
                currentPageServices = totalPages;
            } else if (totalPages === 0) {
                currentPageServices = 1;
            }

            const startIndex = itemsPerPageServices === -1 ? 0 : (currentPageServices - 1) * itemsPerPageServices;
            const endIndex = itemsPerPageServices === -1 ? totalItems : Math.min(startIndex + itemsPerPageServices, totalItems);
            
            cardsServices.forEach(card => card.style.display = 'none'); 
            for (let i = 0; i < filteredCards.length; i++) {
                if (itemsPerPageServices === -1 || (i >= startIndex && i < endIndex)) {
                    filteredCards[i].style.display = ''; 
                } else {
                    filteredCards[i].style.display = 'none';
                }
            }
            
            if (totalItems === 0) {
                paginationInfoServices.textContent = "Mostrando 0 a 0 de 0 entradas";
            } else {
                paginationInfoServices.textContent = `Mostrando ${startIndex + 1} a ${endIndex} de ${totalItems} entradas`;
            }
            updatePaginationControlsServices(totalPages);
        }

        function updatePaginationControlsServices(totalPages) {
            pageNumbersContainerServices.innerHTML = ''; 
            prevButtonServices.classList.toggle('disabled', currentPageServices === 1 || totalPages === 0);
            nextButtonServices.classList.toggle('disabled', currentPageServices === totalPages || totalPages === 0);
            
            if (totalPages > 0) {
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.classList.add('paginate_button', 'page-item');
                    if (i === currentPageServices) {
                        li.classList.add('active');
                    }
                    const a = document.createElement('a');
                    a.href = "#";
                    a.classList.add('page-link');
                    a.textContent = i;
                    a.dataset.page = i;
                    a.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPageServices = parseInt(this.dataset.page);
                        filterAndPaginateServices();
                    });
                    li.appendChild(a);
                    pageNumbersContainerServices.appendChild(li);
                }
            }
        }

        itemsPerPageSelectServices.addEventListener('change', function() {
            itemsPerPageServices = parseInt(this.value);
            currentPageServices = 1; 
            filterAndPaginateServices();
        });

        searchInputServices.addEventListener('keyup', filterAndPaginateServices);

        prevButtonServices.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPageServices > 1) {
                currentPageServices--;
                filterAndPaginateServices();
            }
        });

        nextButtonServices.addEventListener('click', function(e) {
            e.preventDefault();
            const totalItems = cardsServices.filter(card => {
                const cardText = card.getAttribute('data-search-term');
                return cardText.includes(searchInputServices.value.toLowerCase().trim());
            }).length;
            const totalPages = itemsPerPageServices === -1 ? 1 : Math.ceil(totalItems / itemsPerPageServices);
            if (currentPageServices < totalPages) {
                currentPageServices++;
                filterAndPaginateServices();
            }
        });

        filterAndPaginateServices(); 
    });
</script>
{% endblock %}