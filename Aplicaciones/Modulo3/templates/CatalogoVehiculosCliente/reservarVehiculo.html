{% extends "plantilla.html" %} 
{% load static %}

{% block body %} 

<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="text-center mx-auto pb-5 wow fadeInUp" data-wow-delay="0.2s" style="max-width: 800px;">
            <h4 class="text-primary">Agendamiento de Turno para Reserva de Vehículo</h4>
            <h1 class="display-4 mb-4">Reserva tu {{ vehiculo.marca.nombre }} {{ vehiculo.modelo.nombre }}</h1>
            <p class="mb-0">Selecciona la fecha y hora para agendar tu visita o prueba de manejo.</p>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="bg-secondary rounded p-4">
                    <h5 class="text-white mb-4">Seleccionar fecha y hora:</h5>
                    <div class="mb-3 text-white">
                        <p><strong>Vehículo:</strong> {{ vehiculo.marca.nombre }} {{ vehiculo.modelo.nombre }} ({{ vehiculo.anio_fabricacion }})</p>
                        <p><strong>Precio:</strong> ${{ vehiculo.precio|floatformat:2 }}</p>
                    </div>

                    <div class="calendar-navigation mb-3 d-flex justify-content-between align-items-center">
                        <button id="prevMonth" class="btn btn-primary"><i class="fa fa-chevron-left"></i> Anterior</button>
                        <h4 class="mb-0 text-white" id="currentMonthYear">Octubre 2020</h4> 
                        <button id="nextMonth" class="btn btn-primary">Siguiente <i class="fa fa-chevron-right"></i></button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-dark table-bordered text-center calendar-table">
                            <thead>
                                <tr>
                                    <th>Lun</th>
                                    <th>Mar</th>
                                    <th>Mié</th>
                                    <th>Jue</th>
                                    <th>Vie</th>
                                    <th>Sáb</th>
                                    <th>Dom</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="calendar-legend mt-3 d-flex justify-content-around flex-wrap text-white">
                        <span class="badge bg-success m-1">Disponible</span>
                        <span class="badge bg-danger m-1">No disponible</span>
                        <span class="badge bg-warning m-1">Reservado</span>
                        <span class="badge bg-info m-1">Fecha actual</span>
                    </div>

                    <form id="reservationForm" method="post" action="{% url 'confirmar_reserva' vehiculo.id %}" class="mt-4">
                        {% csrf_token %}
                        <input type="hidden" name="selected_date" id="selectedDate">
                        <input type="hidden" name="selected_time" id="selectedTime">

                        <div class="mb-3">
                            <label for="nombreCliente" class="form-label text-white">Tu Nombre:</label>
                            <input type="text" class="form-control" id="nombreCliente" name="nombre_cliente" required>
                        </div>
                        <div class="mb-3">
                            <label for="emailCliente" class="form-label text-white">Tu Email:</label>
                            <input type="email" class="form-control" id="emailCliente" name="email_cliente" required>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'catalogo_vehiculos_cliente' %}" class="btn btn-secondary">Regresar al Catálogo</a>
                            <button type="submit" class="btn btn-success" id="btnAgendar" disabled>Agendar Turno</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarBody = document.getElementById('calendarBody');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const selectedDateInput = document.getElementById('selectedDate');
        const selectedTimeInput = document.getElementById('selectedTime');
        const btnAgendar = document.getElementById('btnAgendar');

        let currentDate = new Date();

        function renderCalendar(date) {
            calendarBody.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const today = new Date();
            currentMonthYear.textContent = new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            let startDay = firstDayOfMonth.getDay();
            if (startDay === 0) startDay = 7; 
            startDay = startDay - 1; 

            let dateCounter = 1;
            let row = calendarBody.insertRow();
            for (let i = 0; i < startDay; i++) {
                let cell = row.insertCell();
                cell.classList.add('table-secondary', 'text-muted'); 
            }
            while (dateCounter <= lastDayOfMonth.getDate()) {
                if (row.cells.length === 7) {
                    row = calendarBody.insertRow();
                }

                let cell = row.insertCell();
                let day = dateCounter;
                let fullDate = new Date(year, month, day);

                cell.textContent = day;
                cell.classList.add('calendar-day');
                if (fullDate.toDateString() === today.toDateString()) {
                    cell.classList.add('bg-info', 'text-white');
                }
                if (fullDate.getDay() === 0 || fullDate.getDay() === 6) { 
                     cell.classList.add('bg-danger', 'text-white'); 
                     cell.title = "Día no disponible";
                     if (fullDate.getDay() === 6 && day % 2 === 0) { 
                         cell.classList.remove('bg-danger');
                         cell.classList.add('bg-warning', 'text-dark');
                         cell.title = "Reservado en algunos horarios";
                     }
                } else {
                    cell.classList.add('bg-success'); 
                    cell.style.cursor = 'pointer';
                    cell.addEventListener('click', function() {
                        document.querySelectorAll('.calendar-day.selected').forEach(s => s.classList.remove('selected'));
                        document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
                        cell.classList.add('selected');
                        selectedDateInput.value = fullDate.toISOString().split('T')[0]; 
                        selectedTimeInput.value = ''; 

                        renderTimeSlots(cell, fullDate); 
                    });
                }
                dateCounter++;
            }
            while (row.cells.length < 7) {
                let cell = row.insertCell();
                cell.classList.add('table-secondary', 'text-muted');
            }
        }

        function renderTimeSlots(dayCell, date) {
            const timeSlotsContainer = document.getElementById('timeSlotsContainer'); 
            if (!timeSlotsContainer) {
                const form = document.getElementById('reservationForm');
                const timeContainerDiv = document.createElement('div');
                timeContainerDiv.id = 'timeSlotsContainer';
                timeContainerDiv.className = 'mt-4 mb-4';
                form.insertBefore(timeContainerDiv, form.querySelector('.d-flex.justify-content-between'));

            }
            timeSlotsContainer.innerHTML = '';
            timeSlotsContainer.style.display = 'block'; 
            const availableTimes = [
                { time: '09:00', status: 'available' },
                { time: '10:00', status: 'booked' },
                { time: '11:00', status: 'available' },
                { time: '12:00', status: 'available' },
                { time: '13:00', status: 'booked' },
                { time: '14:00', status: 'available' },
                { time: '15:00', status: 'available' }
            ];

            availableTimes.forEach(slot => {
                const timeDiv = document.createElement('button');
                timeDiv.type = 'button'; 
                timeDiv.classList.add('btn', 'm-1', 'time-slot');
                timeDiv.textContent = slot.time;

                if (slot.status === 'available') {
                    timeDiv.classList.add('btn-outline-success');
                    timeDiv.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
                        timeDiv.classList.add('selected');
                        selectedTimeInput.value = slot.time;
                        btnAgendar.disabled = false; 
                    });
                } else if (slot.status === 'booked') {
                    timeDiv.classList.add('btn-outline-warning');
                    timeDiv.disabled = true;
                    timeDiv.title = 'Reservado';
                } else { 
                    timeDiv.classList.add('btn-outline-danger');
                    timeDiv.disabled = true;
                    timeDiv.title = 'No disponible';
                }
                timeSlotsContainer.appendChild(timeDiv);
            });
        }

        prevMonthBtn.addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
            btnAgendar.disabled = true; 
            selectedDateInput.value = '';
            selectedTimeInput.value = '';
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            if (timeSlotsContainer) timeSlotsContainer.innerHTML = ''; 
        });

        nextMonthBtn.addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
            btnAgendar.disabled = true; 
            selectedDateInput.value = '';
            selectedTimeInput.value = '';
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            if (timeSlotsContainer) timeSlotsContainer.innerHTML = ''; 
        });
        renderCalendar(currentDate);
    });
</script>
{% endblock %}